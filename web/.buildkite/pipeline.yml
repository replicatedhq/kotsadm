steps:
  - command: cd web && make deps test && yarn run publish:pact
    label: "test-and-build"
    plugins:
      - docker#v3.0.1:
          image: replicated/gitops-builder:buildkite
          workdir: /repo/web
          environment:
            - PACT_BROKER_USERNAME
            - PACT_BROKER_PASSWORD

  - wait

  - trigger: "kotsadm-api"
    async: false
    build:
      message: "${BUILDKITE_MESSAGE}"
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"
      env:
        GIT_TAG: "${GIT_TAG}"

  - wait

  - commands:
      - make -C web deps build-kotsadm
    label: "build-kotsadm"
    plugins:
      - docker#v3.0.1:
          image: replicated/gitops-builder:buildkite
          workdir: /repo/web
          environment:
            - BUILDKITE_COMMIT
            - GIT_TAG
    artifact_paths:
      - "web/dist/**/*"

  - commands:
      - make -C web deps build-replicated-staging
    label: "build-replicated-staging"
    plugins:
      - docker#v3.0.1:
          image: replicated/gitops-builder:buildkite
          workdir: /repo/web
          environment:
            - BUILDKITE_COMMIT
    artifact_paths:
      - "web/dist/**/*"

  - commands:
      - make -C web deps build-replicated-production
    label: "build-replicated-production"
    plugins:
      - docker#v3.0.1:
          image: replicated/gitops-builder:buildkite
          workdir: /repo/web
          environment:
            - BUILDKITE_COMMIT
            - GIT_TAG
    artifact_paths:
      - "web/dist/**/*"

  - wait

  - label: publish-kotsadm-alpha
    branches: "master"
    command: |
      # publish always, image tag is based on git tag
      mkdir -p web/dist;
      buildkite-agent artifact download web/dist/* . --step build-kotsadm
      make -C web publish-kotsadm-alpha;

  - label: publish-kotsadm-release
    command: |
      # publish always, image tag is based on git tag
      if [ ! -z "$GIT_TAG" ]; then \
        mkdir -p web/dist;
        buildkite-agent artifact download web/dist/* . --step build-kotsadm
        make -C web publish-kotsadm-tag;
      fi

  - label: publish-replicated-staging
    branches: "master"
    command: |
      mkdir -p web/dist;
      buildkite-agent artifact download web/dist/* . --step build-replicated-staging && \
      make -C web publish-replicated-staging release-replicated-staging;

  - label: publish-replicated-production
    command: |
      if [ ! -z "$GIT_TAG" ]; then \
        mkdir -p web/dist;
        buildkite-agent artifact download web/dist/* . --step build-replicated-production && \
        make -C web publish-replicated-production release-replicated-production;
      fi
